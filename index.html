<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Conjuntos - Datos Reales</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .filter-btn-active { background:#1d4ed8 !important; color:#fff !important; }
    .table-container { max-height: 600px; overflow-y:auto; }
    #drop-zone.dragover { background:#eff6ff; border-color:#3b82f6; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen pb-12">
  <div class="max-w-6xl mx-auto px-4 pt-8">

    <!-- Header + Upload -->
    <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-200 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
      <div>
        <h1 class="text-3xl font-extrabold text-slate-800 text-center md:text-left">Análisis de Conjuntos</h1>
        <p class="text-slate-500 mt-2 font-medium text-center md:text-left">Subí tu archivo CSV para visualizar los datos reales.</p>
        <p id="status" class="text-sm mt-2 text-slate-500"></p>
      </div>

      <div id="drop-zone" class="w-full md:w-auto border-2 border-dashed border-slate-300 rounded-xl p-4 transition-all text-center">
        <input type="file" id="fileInput" accept=".csv" class="hidden">
        <label for="fileInput" class="cursor-pointer">
          <div class="flex flex-col items-center">
            <svg class="w-8 h-8 text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
              </path>
            </svg>
            <span class="text-sm font-bold text-blue-600">Subir BaseDeDatos.csv</span>
            <span class="text-xs text-slate-400">Clic o arrastrar aquí</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Content -->
    <div id="dashboard-content" class="hidden opacity-0 transition-opacity duration-500">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-4">
          <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg shadow-blue-200">
            <span class="block text-xs font-bold uppercase tracking-wider opacity-80">Total en Base de Datos</span>
            <span id="total-students" class="text-4xl font-black">0</span>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Operaciones</h2>

            <div class="flex flex-col gap-2">
              <button onclick="filterData('all')" id="btn-all" class="filter-btn w-full text-left px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition-all flex justify-between items-center">
                <span>Ver Todos</span><span class="text-xs bg-slate-200 px-2 py-0.5 rounded" id="count-all">0</span>
              </button>

              <hr class="my-2 border-slate-100">

              <button onclick="filterData('aub')" id="btn-aub" class="filter-btn w-full text-left px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition-all flex justify-between items-center">
                <span>A ∪ B</span><span class="text-xs bg-slate-200 px-2 py-0.5 rounded" id="count-aub">0</span>
              </button>

              <button onclick="filterData('anc')" id="btn-anc" class="filter-btn w-full text-left px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition-all flex justify-between items-center">
                <span>A ∩ C</span><span class="text-xs bg-slate-200 px-2 py-0.5 rounded" id="count-anc">0</span>
              </button>

              <button onclick="filterData('bmd')" id="btn-bmd" class="filter-btn w-full text-left px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition-all flex justify-between items-center">
                <span>B − D</span><span class="text-xs bg-slate-200 px-2 py-0.5 rounded" id="count-bmd">0</span>
              </button>

              <button onclick="filterData('adb')" id="btn-adb" class="filter-btn w-full text-left px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition-all flex justify-between items-center">
                <span>A △ B</span><span class="text-xs bg-slate-200 px-2 py-0.5 rounded" id="count-adb">0</span>
              </button>

              <button onclick="filterData('dc')" id="btn-dc" class="filter-btn w-full text-left px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition-all flex justify-between items-center">
                <span>Dᶜ</span><span class="text-xs bg-slate-200 px-2 py-0.5 rounded" id="count-dc">0</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="lg:col-span-3">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
              <h2 id="current-op-title" class="font-bold text-slate-700">Seleccionados</h2>
              <span id="result-badge" class="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full">0 resultados</span>
            </div>

            <div class="table-container">
              <table class="w-full text-sm text-left">
                <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                  <tr>
                    <th class="px-6 py-4 border-b">Nombre</th>
                    <th class="px-4 py-4 text-center border-b">A</th>
                    <th class="px-4 py-4 text-center border-b">B</th>
                    <th class="px-4 py-4 text-center border-b">C</th>
                    <th class="px-4 py-4 text-center border-b">D</th>
                  </tr>
                </thead>
                <tbody id="student-table-body" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- Welcome -->
    <div id="welcome-message" class="bg-white p-12 rounded-2xl border border-slate-200 text-center">
      <h2 class="text-xl font-bold text-slate-800 mb-2">Esperando datos...</h2>
      <p class="text-slate-500">Seleccioná tu archivo <strong>BaseDeDatos.csv</strong> para comenzar.</p>
    </div>

  </div>

  <script>
    let students = [];

    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('drop-zone');
    const statusEl = document.getElementById('status');

    fileInput.addEventListener('change', handleFile);

    // Drag & Drop (opcional pero útil)
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files?.length) {
        fileInput.files = e.dataTransfer.files;
        handleFile({ target: fileInput });
      }
    });

    function detectDelimiter(text) {
      const firstLine = text.split(/\r?\n/).find(l => l.trim() !== "") || "";
      const commas = (firstLine.match(/,/g) || []).length;
      const semis  = (firstLine.match(/;/g) || []).length;
      return semis > commas ? ";" : ",";
    }

    function parse01(v) {
      const n = Number(String(v ?? "").trim());
      return n === 1 ? 1 : 0;
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      statusEl.textContent = `Leyendo: ${file.name} ...`;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          processCSV(event.target.result);
          statusEl.textContent = `✅ Cargado: ${students.length} estudiantes.`;
        } catch (err) {
          console.error(err);
          statusEl.textContent = `❌ Error: ${err.message}`;
        }
      };
      reader.readAsText(file);
    }

    function processCSV(text) {
      const delimiter = detectDelimiter(text);
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");

      if (lines.length < 2) throw new Error("El CSV no tiene suficientes filas.");

      // Detectar encabezado
      const hasHeader = lines[0].toLowerCase().includes("nombre");

      const dataLines = hasHeader ? lines.slice(1) : lines;

      students = dataLines.map(line => {
        const parts = line.split(delimiter).map(x => x.trim());

        // Esperado mínimo: Nombre + A B C D
        const nombre = parts[0] ?? "";

        const a = parse01(parts[1]);
        const b = parse01(parts[2]);
        const c = parse01(parts[3]);
        const d = parse01(parts[4]);

        // Si trae columnas calculadas, las toma; si no, calcula:
        const aub = parts[5] !== undefined ? parse01(parts[5]) : ((a === 1 || b === 1) ? 1 : 0);
        const anc = parts[6] !== undefined ? parse01(parts[6]) : ((a === 1 && c === 1) ? 1 : 0);
        const bmd = parts[7] !== undefined ? parse01(parts[7]) : ((b === 1 && d === 0) ? 1 : 0);
        const adb = parts[8] !== undefined ? parse01(parts[8]) : ((a !== b) ? 1 : 0);
        const dc  = parts[9] !== undefined ? parse01(parts[9]) : ((d === 0) ? 1 : 0);

        return { nombre, a, b, c, d, aub, anc, bmd, adb, dc };
      });

      updateUI();
    }

    function updateUI() {
      if (!students.length) return;

      document.getElementById('welcome-message').classList.add('hidden');
      const content = document.getElementById('dashboard-content');
      content.classList.remove('hidden');
      setTimeout(() => content.classList.add('opacity-100'), 50);

      const counts = {
        all: students.length,
        aub: students.filter(s => s.aub === 1).length,
        anc: students.filter(s => s.anc === 1).length,
        bmd: students.filter(s => s.bmd === 1).length,
        adb: students.filter(s => s.adb === 1).length,
        dc:  students.filter(s => s.dc  === 1).length
      };

      document.getElementById('total-students').innerText = counts.all;
      Object.keys(counts).forEach(k => document.getElementById('count-' + k).innerText = counts[k]);

      filterData('all');
    }

    function setActive(op) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
      const btn = document.getElementById('btn-' + op);
      if (btn) btn.classList.add('filter-btn-active');
    }

    function filterData(op) {
      setActive(op);

      let filtered = [];
      let title = "";

      switch(op) {
        case 'all': filtered = students; title = "Todos los Estudiantes"; break;
        case 'aub': filtered = students.filter(s => s.aub === 1); title = "A ∪ B (Unión)"; break;
        case 'anc': filtered = students.filter(s => s.anc === 1); title = "A ∩ C (Intersección)"; break;
        case 'bmd': filtered = students.filter(s => s.bmd === 1); title = "B − D (Diferencia)"; break;
        case 'adb': filtered = students.filter(s => s.adb === 1); title = "A △ B (Dif. Simétrica)"; break;
        case 'dc':  filtered = students.filter(s => s.dc  === 1); title = "Dᶜ (Complemento)"; break;
      }

      document.getElementById('current-op-title').innerText = title;
      document.getElementById('result-badge').innerText = `${filtered.length} resultados`;

      const tbody = document.getElementById('student-table-body');
      tbody.innerHTML = filtered.map(s => `
        <tr class="hover:bg-blue-50/30">
          <td class="px-6 py-4 font-semibold text-slate-700">${escapeHtml(s.nombre)}</td>
          <td class="px-4 py-4 text-center">${dot(s.a)}</td>
          <td class="px-4 py-4 text-center">${dot(s.b)}</td>
          <td class="px-4 py-4 text-center">${dot(s.c)}</td>
          <td class="px-4 py-4 text-center">${dot(s.d)}</td>
        </tr>
      `).join('');
    }

    function dot(v) {
      return v ? '<span class="text-blue-600">●</span>' : '<span class="text-slate-200">○</span>';
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
